name: Generate and Publish RSS Feed
on:
  schedule:
    # Run at 10:10 AM Japan time (01:10 UTC)
    - cron: '10 1 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main
    paths:
      - 'rss.xml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Download JSON and Generate RSS
        run: |
          # Download the JSON file
          curl -s https://kosodate-green.mlit.go.jp/assets/data/news.json > news.json
          
          # Get current date in RFC 2822 format for the feed
          BUILD_DATE=$(date -R)
          
          # Calculate date 14 days ago in YYYY/MM/DD format for filtering
          FOURTEEN_DAYS_AGO=$(date -d "14 days ago" +"%Y/%m/%d")
          
          # Check if rss.xml exists
          if [ -f "rss.xml" ]; then
            echo "Updating existing RSS feed"
          else
            echo "Creating new RSS feed"
          fi
          
          # Create RSS file header
          cat > rss.xml.new << EOF
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
    <title>子育てグリーン住宅支援事業 新着情報</title>
    <link>https://kosodate-green.mlit.go.jp/</link>
    <description>子育てグリーン住宅支援事業のホームページの新着情報</description>
    <language>ja-jp</language>
    <lastBuildDate>${BUILD_DATE}</lastBuildDate>
    <atom:link href="https://${GITHUB_REPOSITORY_OWNER}.github.io/Green-rss/rss.xml" rel="self" type="application/rss+xml" />
EOF
          
          # Process JSON and append items to RSS
          jq -r '.list[] | select(.date >= "'${FOURTEEN_DAYS_AGO}'") | [.id, .title, .date, .url] | @tsv' news.json | 
          while IFS=$'\t' read -r id title date url; do
            # Skip items with empty URL
            if [ -z "$url" ] || [ "$url" = "null" ]; then
              url="https://kosodate-green.mlit.go.jp/"
            fi
            
            # Convert date to RFC 2822 format for RSS
            rfc_date=$(date -R -d "${date}")
            
            # Create item entry
            cat >> rss.xml.new << EOF
    <item>
        <title>${title}</title>
        <link>${url}</link>
        <guid isPermaLink="false">${id}</guid>
        <pubDate>${rfc_date}</pubDate>
        <description>${title}</description>
    </item>
EOF
          done
          
          # Close RSS file
          cat >> rss.xml.new << EOF
</channel>
</rss>
EOF
          
          # Check if the RSS feed has changed
          if [ -f "rss.xml" ] && diff -q rss.xml rss.xml.new > /dev/null; then
            echo "No changes detected in RSS feed"
            rm rss.xml.new
            exit 0
          else
            mv rss.xml.new rss.xml
            echo "RSS feed updated"
          fi

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push if there are changes
        run: |
          git add rss.xml
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          else
            git commit -m "Update RSS feed [skip ci]"
            git push
          fi

  deploy:
    needs: generate
    if: success() && github.event_name != 'schedule'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create _headers file for correct MIME type
        run: |
          mkdir -p _site
          echo "/rss.xml" > _site/_headers
          echo "  Content-Type: application/rss+xml; charset=utf-8" >> _site/_headers
          cp rss.xml _site/
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
